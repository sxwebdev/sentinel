<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>{{.Title}}</h1>
        {{if .Actions}}
        <div class="header-actions">
          {{range .Actions}}
          <button class="btn {{.Class}}" onclick="refreshServicesTable()">
            {{.Text}}
          </button>
          {{end}}
          <button class="btn btn-primary" onclick="openAddServiceModal()">
            Add Service
          </button>
        </div>
        {{end}}
      </div>

      <!-- Dashboard Statistics -->
      <div class="stats-grid">
        <div class="dashboard-stat-card">
          <div class="stat-value" id="totalServices">-</div>
          <div class="stat-label">Всего сервисов</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="servicesUp">-</div>
          <div class="stat-label">Работают</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="servicesDown">-</div>
          <div class="stat-label">Не работают</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="activeIncidents">-</div>
          <div class="stat-label">Активные инциденты</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="uptimePercentage">-</div>
          <div class="stat-label">Uptime</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="avgResponseTime">-</div>
          <div class="stat-label">Среднее время ответа (мс)</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="totalChecks">-</div>
          <div class="stat-label">Всего проверок</div>
        </div>
        <div class="dashboard-stat-card">
          <div class="stat-value" id="checksPerMinute">-</div>
          <div class="stat-label">Проверок в минуту</div>
        </div>
      </div>

      <!-- Protocol Distribution -->
      <div class="accordion-card" style="margin-bottom: 1.5rem">
        <div
          class="accordion-header"
          onclick="toggleAccordion('protocolAccordion')"
        >
          <h3>Распределение по протоколам</h3>
          <span class="accordion-icon" id="protocolAccordionIcon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-chevron-down-icon lucide-chevron-down"
            >
              <path d="m6 9 6 6 6-6" />
            </svg>
          </span>
        </div>
        <div class="accordion-body" id="protocolAccordion">
          <div class="protocol-stats" id="protocolStats">
            <div class="loading">Загрузка...</div>
          </div>
        </div>
      </div>

      <!-- Services Table -->
      <div class="card">
        <div class="card-header">
          <h3>Services Overview</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th style="width: 40px; text-align: center">Enabled</th>
                  <th>Service</th>
                  <th>Status</th>
                  <th>Tags</th>
                  <th>Endpoint</th>
                  <th>Last Check</th>
                  <th>Incidents</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="loading-row">
                    <div class="loading">Загрузка сервисов...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div id="serviceModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add Service</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="serviceForm">
            <div class="form-group">
              <label for="name">Service Name *</label>
              <input type="text" id="name" name="name" required />
            </div>
            <div class="form-group">
              <label for="protocol">Protocol *</label>
              <select
                id="protocol"
                name="protocol"
                required
                onchange="updateConfigFields()"
              >
                <option value="">Select Protocol</option>
                <option value="http">HTTP/HTTPS</option>
                <option value="tcp">TCP</option>
                <option value="grpc">gRPC</option>
                <option value="redis">Redis</option>
              </select>
            </div>
            <div class="form-group">
              <label for="endpoint">Endpoint *</label>
              <input type="text" id="endpoint" name="endpoint" required />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="interval">Interval (seconds)</label>
                <input
                  type="number"
                  id="interval"
                  name="interval"
                  value="30"
                  min="1"
                />
              </div>
              <div class="form-group">
                <label for="timeout">Timeout (seconds)</label>
                <input
                  type="number"
                  id="timeout"
                  name="timeout"
                  value="10"
                  min="1"
                />
              </div>
              <div class="form-group">
                <label for="retries">Retries</label>
                <input
                  type="number"
                  id="retries"
                  name="retries"
                  value="3"
                  min="0"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="tags">Tags (comma-separated)</label>
              <input
                type="text"
                id="tags"
                name="tags"
                placeholder="api, critical, production"
              />
            </div>
            <div class="form-group">
              <label for="is_enabled">Enabled Service</label>
              <div class="switch-container" onclick="toggleSwitch()">
                <input
                  type="checkbox"
                  id="is_enabled"
                  name="is_enabled"
                  checked
                />
                <span class="switch-slider"></span>
              </div>
            </div>

            <!-- Multi-endpoint configuration section -->
            <div class="form-group">
              <label for="multi_endpoint_enabled"
                >Multi-Endpoint Monitoring</label
              >
              <div class="switch-container" onclick="toggleMultiEndpoint()">
                <input
                  type="checkbox"
                  id="multi_endpoint_enabled"
                  name="multi_endpoint_enabled"
                />
                <span class="switch-slider"></span>
              </div>
            </div>

            <div
              class="form-group"
              id="multi_endpoint_config"
              style="display: none"
            >
              <div class="card">
                <div class="card-header">
                  <h4>Multi-Endpoint Configuration</h4>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <label for="condition">JavaScript Condition</label>
                    <textarea
                      id="condition"
                      name="condition"
                      placeholder="// Example: return Math.abs(results.main.value - results.backup.value) > 5;"
                      rows="4"
                    ></textarea>
                    <small class="form-text">
                      JavaScript condition that returns true to trigger an
                      incident. Available variables:
                      <code>results.endpoint_name.value</code>,
                      <code>results.endpoint_name.success</code>, etc.
                    </small>
                  </div>

                  <div class="form-group">
                    <label for="multi_timeout">Timeout (seconds)</label>
                    <input
                      type="number"
                      id="multi_timeout"
                      name="multi_timeout"
                      value="30"
                      min="1"
                      max="300"
                    />
                  </div>

                  <div class="form-group">
                    <label>Endpoints</label>
                    <div id="endpoints_container">
                      <div class="endpoint-item">
                        <div class="endpoint-header">
                          <h5>Endpoint 1</h5>
                          <button
                            type="button"
                            class="btn btn-danger btn-sm"
                            onclick="removeEndpoint(this)"
                          >
                            Remove
                          </button>
                        </div>
                        <div class="form-row">
                          <div class="form-group">
                            <label>Name</label>
                            <input
                              type="text"
                              name="endpoint_name[]"
                              placeholder="main"
                              required
                            />
                          </div>
                          <div class="form-group">
                            <label>URL</label>
                            <input
                              type="url"
                              name="endpoint_url[]"
                              placeholder="https://api.example.com/status"
                              required
                            />
                          </div>
                        </div>
                        <div class="form-row">
                          <div class="form-group">
                            <label>Method</label>
                            <select name="endpoint_method[]">
                              <option value="GET">GET</option>
                              <option value="POST">POST</option>
                              <option value="PUT">PUT</option>
                              <option value="DELETE">DELETE</option>
                              <option value="HEAD">HEAD</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label>JSON Path</label>
                            <input
                              type="text"
                              name="endpoint_json_path[]"
                              placeholder="result.block_number"
                            />
                            <small class="form-text"
                              >Path to extract value from JSON response (e.g.,
                              "result.block_number")</small
                            >
                          </div>
                        </div>
                        <div class="form-row">
                          <div class="form-group">
                            <label>Username (Basic Auth)</label>
                            <input
                              type="text"
                              name="endpoint_username[]"
                              placeholder="username"
                            />
                          </div>
                          <div class="form-group">
                            <label>Password (Basic Auth)</label>
                            <input
                              type="password"
                              name="endpoint_password[]"
                              placeholder="password"
                            />
                          </div>
                        </div>
                        <div class="form-group">
                          <label>Headers (JSON)</label>
                          <textarea
                            name="endpoint_headers[]"
                            placeholder='{"Authorization": "Bearer token"}'
                            rows="2"
                          ></textarea>
                        </div>
                        <div class="form-group">
                          <label>Body</label>
                          <textarea
                            name="endpoint_body[]"
                            placeholder="Request body (for POST/PUT)"
                            rows="2"
                          ></textarea>
                        </div>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn btn-secondary"
                      onclick="addEndpoint()"
                    >
                      Add Endpoint
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="config">Configuration (JSON)</label>
              <textarea
                id="config"
                name="config"
                rows="8"
                placeholder='{"method": "GET", "expected_status": 200, "headers": {}}'
              ></textarea>
              <small class="form-text">
                Enter configuration in JSON format. Examples:
                <br />HTTP:
                <code
                  >{"method": "GET", "expected_status": 200, "headers":
                  {"Authorization": "Bearer token"}}</code
                >
                <br />TCP:
                <code>{"send_data": "ping", "expect_data": "pong"}</code>
                <br />gRPC:
                <code
                  >{"check_type": "connectivity", "service_name": "", "tls":
                  true, "insecure_tls": false}</code
                >
                <br />Redis: <code>{"password": "secret", "db": 0}</code>
              </small>
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeModal()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save Service
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      let currentServiceId = null;

      // Load dashboard statistics
      function loadDashboardStats() {
        fetch("/api/v1/dashboard/stats")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((stats) => {
            // Update main statistics
            document.getElementById("totalServices").textContent =
              stats.total_services;
            document.getElementById("servicesUp").textContent =
              stats.services_up;
            document.getElementById("servicesDown").textContent =
              stats.services_down;
            document.getElementById("uptimePercentage").textContent =
              stats.uptime_percentage.toFixed(1) + "%";
            document.getElementById("activeIncidents").textContent =
              stats.active_incidents;
            document.getElementById("avgResponseTime").textContent =
              stats.avg_response_time + " мс";
            document.getElementById("totalChecks").textContent =
              stats.total_checks;
            document.getElementById("checksPerMinute").textContent =
              stats.checks_per_minute;

            // Update card colors based on values
            updateStatCardColors(stats);

            // Update protocol distribution
            updateProtocolStats(stats.protocols);
          })
          .catch((error) => {
            console.error("Failed to load dashboard stats:", error);
          });
      }

      // Update protocol statistics
      function updateProtocolStats(protocols) {
        const container = document.getElementById("protocolStats");
        if (!container) return;

        if (Object.keys(protocols).length === 0) {
          container.innerHTML = '<div class="no-data">Нет данных</div>';
          return;
        }

        let html = '<div class="protocol-grid">';
        for (const [protocol, count] of Object.entries(protocols)) {
          const protocolName = getProtocolDisplayName(protocol);
          const percentage = (
            (count / Object.values(protocols).reduce((a, b) => a + b, 0)) *
            100
          ).toFixed(1);

          html += `
            <div class="protocol-item">
              <div class="protocol-name">${protocolName}</div>
              <div class="protocol-count">${count}</div>
              <div class="protocol-bar">
                <div class="protocol-bar-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="protocol-percentage">${percentage}%</div>
            </div>
          `;
        }
        html += "</div>";
        container.innerHTML = html;
      }

      // Get display name for protocol
      function getProtocolDisplayName(protocol) {
        const names = {
          http: "HTTP/HTTPS",
          tcp: "TCP",
          grpc: "gRPC",
          redis: "Redis",
          unknown: "Неизвестно",
        };
        return names[protocol] || protocol.toUpperCase();
      }

      // Update stat card colors based on values
      function updateStatCardColors(stats) {
        // Update uptime percentage color
        const uptimeCard = document
          .getElementById("uptimePercentage")
          .closest(".dashboard-stat-card");
        if (stats.uptime_percentage >= 99) {
          uptimeCard.className = "dashboard-stat-card success";
        } else if (stats.uptime_percentage >= 95) {
          uptimeCard.className = "dashboard-stat-card warning";
        } else {
          uptimeCard.className = "dashboard-stat-card danger";
        }

        // Update active incidents color
        const incidentsCard = document
          .getElementById("activeIncidents")
          .closest(".dashboard-stat-card");
        if (stats.active_incidents === 0) {
          incidentsCard.className = "dashboard-stat-card success";
        } else if (stats.active_incidents <= 2) {
          incidentsCard.className =
            "dashboard-stat-card warning has-active-incidents";
        } else {
          incidentsCard.className =
            "dashboard-stat-card danger has-active-incidents";
        }

        // Update response time color
        const responseCard = document
          .getElementById("avgResponseTime")
          .closest(".dashboard-stat-card");
        if (stats.avg_response_time <= 200) {
          responseCard.className = "dashboard-stat-card success";
        } else if (stats.avg_response_time <= 1000) {
          responseCard.className = "dashboard-stat-card warning";
        } else {
          responseCard.className = "dashboard-stat-card danger";
        }
      }

      function triggerCheck(serviceId) {
        closeAllDropdowns();
        fetch(`/api/v1/services/${serviceId}/check`, {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.message) {
              // Refresh only the table instead of reloading the page
              refreshServicesTable();
            }
          })
          .catch((error) => {
            console.error("Failed to trigger check:", error);
          });
      }

      function openAddServiceModal() {
        currentServiceId = null;
        document.getElementById("modalTitle").textContent = "Add Service";
        document.getElementById("serviceForm").reset();
        document.getElementById("config").value = "";

        // Reset multi-endpoint section
        document.getElementById("multi_endpoint_enabled").checked = false;
        document.getElementById("multi_endpoint_config").style.display = "none";
        document.getElementById("endpoints_container").innerHTML = "";

        document.getElementById("serviceModal").style.display = "block";
      }

      function editService(serviceId) {
        closeAllDropdowns();
        currentServiceId = serviceId;
        document.getElementById("modalTitle").textContent = "Edit Service";

        // Load service config for editing
        fetch(`/api/v1/services/config/${serviceId}`)
          .then((response) => response.json())
          .then((serviceConfig) => {
            // Reset multi-endpoint section
            document.getElementById("multi_endpoint_enabled").checked = false;
            document.getElementById("multi_endpoint_config").style.display =
              "none";
            document.getElementById("endpoints_container").innerHTML = "";
            document.getElementById("name").value = serviceConfig.name;
            document.getElementById("protocol").value = serviceConfig.protocol;
            document.getElementById("endpoint").value = serviceConfig.endpoint;
            document.getElementById("interval").value = Math.floor(
              serviceConfig.interval / 1000000000
            ); // Convert from nanoseconds
            document.getElementById("timeout").value = Math.floor(
              serviceConfig.timeout / 1000000000
            );
            document.getElementById("retries").value = serviceConfig.retries;
            document.getElementById("tags").value =
              serviceConfig.tags.join(", ");
            document.getElementById("is_enabled").checked =
              serviceConfig.is_enabled !== false;

            // --- Исправление: универсальный разбор multi-endpoint ---
            console.log("Service config:", serviceConfig);
            console.log("Config object:", serviceConfig.config);

            let config = serviceConfig.config || {};
            let multiEndpointConfig = null;

            // Проверяем все возможные места, где может быть multi_endpoint
            if (config.multi_endpoint) {
              console.log("Found multi_endpoint in config.multi_endpoint");
              multiEndpointConfig = config.multi_endpoint;
            } else if (config.http && config.http.multi_endpoint) {
              console.log("Found multi_endpoint in config.http.multi_endpoint");
              multiEndpointConfig = config.http.multi_endpoint;
              config = config.http; // для отображения остальных полей
            } else if (config.http && config.http.extended_config) {
              console.log(
                "Found multi_endpoint in config.http.extended_config"
              );
              multiEndpointConfig = config.http.extended_config;
              config = config.http; // для отображения остальных полей
            } else if (config.extended_config) {
              console.log("Found multi_endpoint in config.extended_config");
              multiEndpointConfig = config.extended_config;
            } else {
              // Проверяем, может быть multi_endpoint находится в другом месте
              console.log("Checking for multi_endpoint in other locations...");
              console.log("Config keys:", Object.keys(config));
              if (config.http) {
                console.log("HTTP config keys:", Object.keys(config.http));
              }
              console.log("No multi_endpoint found in config");
            }

            console.log("Multi endpoint config:", multiEndpointConfig);

            // Если есть multi-endpoint, подставляем в форму
            if (multiEndpointConfig) {
              document.getElementById("multi_endpoint_enabled").checked = true;
              document.getElementById("multi_endpoint_config").style.display =
                "block";
              document.getElementById("condition").value =
                multiEndpointConfig.condition || "";
              document.getElementById("multi_timeout").value = Math.floor(
                (multiEndpointConfig.timeout || 30000000000) / 1000000000
              );
              // Clear existing endpoints
              const container = document.getElementById("endpoints_container");
              container.innerHTML = "";
              (multiEndpointConfig.endpoints || []).forEach(
                (endpoint, index) => {
                  if (index === 0) {
                    // Create first endpoint
                    const endpointDiv = document.createElement("div");
                    endpointDiv.className = "endpoint-item";
                    endpointDiv.innerHTML = `
                    <div class="endpoint-header">
                      <h5>Endpoint 1</h5>
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeEndpoint(this)">
                        Remove
                      </button>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="endpoint_name[]" placeholder="main" required />
                      </div>
                      <div class="form-group">
                        <label>URL</label>
                        <input type="url" name="endpoint_url[]" placeholder="https://api.example.com/status" required />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Method</label>
                        <select name="endpoint_method[]">
                          <option value="GET">GET</option>
                          <option value="POST">POST</option>
                          <option value="PUT">PUT</option>
                          <option value="DELETE">DELETE</option>
                          <option value="HEAD">HEAD</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>JSON Path</label>
                        <input type="text" name="endpoint_json_path[]" placeholder="result.block_number" />
                        <small class="form-text">Path to extract value from JSON response (e.g., "result.block_number")</small>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Username (Basic Auth)</label>
                        <input type="text" name="endpoint_username[]" placeholder="username" />
                      </div>
                      <div class="form-group">
                        <label>Password (Basic Auth)</label>
                        <input type="password" name="endpoint_password[]" placeholder="password" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>Headers (JSON)</label>
                      <textarea name="endpoint_headers[]" placeholder='{"Authorization": "Bearer token"}' rows="2"></textarea>
                    </div>
                    <div class="form-group">
                      <label>Body</label>
                      <textarea name="endpoint_body[]" placeholder="Request body (for POST/PUT)" rows="2"></textarea>
                    </div>
                  `;
                    container.appendChild(endpointDiv);
                    // Заполняем данные первого эндпоинта
                    const nameInput = container.querySelector(
                      'input[name="endpoint_name[]"]'
                    );
                    const urlInput = container.querySelector(
                      'input[name="endpoint_url[]"]'
                    );
                    const methodSelect = container.querySelector(
                      'select[name="endpoint_method[]"]'
                    );
                    const jsonPathInput = container.querySelector(
                      'input[name="endpoint_json_path[]"]'
                    );
                    const usernameInput = container.querySelector(
                      'input[name="endpoint_username[]"]'
                    );
                    const passwordInput = container.querySelector(
                      'input[name="endpoint_password[]"]'
                    );
                    const headersTextarea = container.querySelector(
                      'textarea[name="endpoint_headers[]"]'
                    );
                    const bodyTextarea = container.querySelector(
                      'textarea[name="endpoint_body[]"]'
                    );
                    if (nameInput) nameInput.value = endpoint.name || "";
                    if (urlInput) urlInput.value = endpoint.url || "";
                    if (methodSelect)
                      methodSelect.value = endpoint.method || "GET";
                    if (jsonPathInput)
                      jsonPathInput.value = endpoint.json_path || "";
                    if (usernameInput)
                      usernameInput.value = endpoint.username || "";
                    if (passwordInput)
                      passwordInput.value = endpoint.password || "";
                    if (headersTextarea)
                      headersTextarea.value = JSON.stringify(
                        endpoint.headers || {},
                        null,
                        2
                      );
                    if (bodyTextarea) bodyTextarea.value = endpoint.body || "";
                  } else {
                    // Add additional endpoints
                    addEndpoint();
                    const endpointItems =
                      container.querySelectorAll(".endpoint-item");
                    const currentItem = endpointItems[endpointItems.length - 1];
                    currentItem.querySelector(
                      'input[name="endpoint_name[]"]'
                    ).value = endpoint.name || "";
                    currentItem.querySelector(
                      'input[name="endpoint_url[]"]'
                    ).value = endpoint.url || "";
                    currentItem.querySelector(
                      'select[name="endpoint_method[]"]'
                    ).value = endpoint.method || "GET";
                    currentItem.querySelector(
                      'input[name="endpoint_json_path[]"]'
                    ).value = endpoint.json_path || "";
                    const usernameInput = currentItem.querySelector(
                      'input[name="endpoint_username[]"]'
                    );
                    const passwordInput = currentItem.querySelector(
                      'input[name="endpoint_password[]"]'
                    );
                    if (usernameInput)
                      usernameInput.value = endpoint.username || "";
                    if (passwordInput)
                      passwordInput.value = endpoint.password || "";
                    currentItem.querySelector(
                      'textarea[name="endpoint_headers[]"]'
                    ).value = JSON.stringify(endpoint.headers || {}, null, 2);
                    currentItem.querySelector(
                      'textarea[name="endpoint_body[]"]'
                    ).value = endpoint.body || "";
                  }
                }
              );
            }

            // Остальной код editService (отображение config в textarea)
            let configJson = "";
            if (config.http) {
              configJson = JSON.stringify(config.http, null, 2);
            } else if (config.tcp) {
              configJson = JSON.stringify(config.tcp, null, 2);
            } else if (config.grpc) {
              configJson = JSON.stringify(config.grpc, null, 2);
            } else if (config.redis) {
              configJson = JSON.stringify(config.redis, null, 2);
            } else {
              // Если обычный http/json config
              configJson = JSON.stringify(config, null, 2);
            }
            document.getElementById("config").value = configJson;
            updateConfigFields();
            document.getElementById("serviceModal").style.display = "block";
          })
          .catch((error) => {
            console.error("Failed to load service config:", error);
            alert("Failed to load service config");
          });
      }

      function deleteService(serviceId, serviceName) {
        closeAllDropdowns();
        if (
          confirm(`Are you sure you want to delete service "${serviceName}"?`)
        ) {
          fetch(`/api/v1/services/${serviceId}`, {
            method: "DELETE",
          })
            .then((response) => {
              if (response.ok) {
                // Refresh only the table instead of reloading the page
                refreshServicesTable();
              } else {
                return response.json();
              }
            })
            .then((data) => {
              if (data && data.error) {
                alert("Failed to delete service: " + data.error);
              }
            })
            .catch((error) => {
              console.error("Failed to delete service:", error);
              alert("Failed to delete service");
            });
        }
      }

      function closeModal() {
        document.getElementById("serviceModal").style.display = "none";
      }

      function updateConfigFields() {
        const protocol = document.getElementById("protocol").value;
        const configTextarea = document.getElementById("config");

        // Если поле конфигурации пустое или содержит только базовый placeholder,
        // устанавливаем дефолтное значение для выбранного протокола
        const currentValue = configTextarea.value.trim();
        if (currentValue === "" || currentValue === "{}") {
          let exampleConfig = "";
          switch (protocol) {
            case "http":
              exampleConfig = `{
  "method": "GET",
  "expected_status": 200,
  "headers": {}
}`;
              break;
            case "tcp":
              exampleConfig = `{
  "send_data": "",
  "expect_data": ""
}`;
              break;
            case "grpc":
              exampleConfig = `{
  "check_type": "connectivity",
  "service_name": "",
  "tls": true,
  "insecure_tls": false
}`;
              break;
            case "redis":
              exampleConfig = `{
  "password": "",
  "db": 0
}`;
              break;
          }
          configTextarea.value = exampleConfig;
        }

        // Reset multi-endpoint configuration when protocol changes
        if (protocol !== "http") {
          document.getElementById("multi_endpoint_enabled").checked = false;
          document.getElementById("multi_endpoint_config").style.display =
            "none";
        }
      }

      document
        .getElementById("serviceForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const protocol = formData.get("protocol");
          const multiEndpointEnabled =
            formData.get("multi_endpoint_enabled") === "on";

          console.log("Multi-endpoint enabled:", multiEndpointEnabled);

          let config = null;

          if (multiEndpointEnabled) {
            const endpoints = [];
            const names = formData.getAll("endpoint_name[]");
            const urls = formData.getAll("endpoint_url[]");
            const methods = formData.getAll("endpoint_method[]");
            const jsonPaths = formData.getAll("endpoint_json_path[]");
            const headers = formData.getAll("endpoint_headers[]");
            const bodies = formData.getAll("endpoint_body[]");
            const usernames = formData.getAll("endpoint_username[]");
            const passwords = formData.getAll("endpoint_password[]");

            for (let i = 0; i < names.length; i++) {
              const endpoint = {
                name: names[i],
                url: urls[i],
                method: methods[i],
                json_path: jsonPaths[i],
                headers: {},
                body: bodies[i],
                username: usernames[i] || "",
                password: passwords[i] || "",
              };

              // Parse headers JSON
              if (headers[i] && headers[i].trim()) {
                try {
                  endpoint.headers = JSON.parse(headers[i]);
                } catch (e) {
                  console.error("Invalid headers JSON:", headers[i]);
                }
              }

              endpoints.push(endpoint);
            }

            const multiEndpointConfig = {
              endpoints: endpoints,
              condition: formData.get("condition"),
              timeout: parseInt(formData.get("multi_timeout")) * 1000000000, // Convert to nanoseconds
            };

            // Add multi-endpoint config to the main config
            config = {
              method: "GET",
              expected_status: 200,
              headers: {},
              multi_endpoint: multiEndpointConfig,
            };
            console.log("Multi-endpoint config:", config);
          } else {
            // Parse regular config from textarea as JSON only
            const configText = formData.get("config") || "";
            if (configText.trim()) {
              try {
                config = JSON.parse(configText);
              } catch (e) {
                alert("Invalid JSON configuration. Please check the format.");
                return;
              }
            }
          }

          const service = {
            name: formData.get("name"),
            protocol: formData.get("protocol"),
            endpoint: formData.get("endpoint"),
            interval: parseInt(formData.get("interval")) * 1000000000, // Convert to nanoseconds
            timeout: parseInt(formData.get("timeout")) * 1000000000,
            retries: parseInt(formData.get("retries")),
            tags: formData
              .get("tags")
              .split(",")
              .map((tag) => tag.trim())
              .filter((tag) => tag),
            is_enabled: formData.get("is_enabled") === "on",
            config: config,
          };

          const url = currentServiceId
            ? `/api/v1/services/${currentServiceId}`
            : "/api/v1/services";
          const method = currentServiceId ? "PUT" : "POST";

          fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(service),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                alert("Failed to save service: " + data.error);
              } else {
                closeModal();
                // Wait a bit for the service to be fully initialized, then refresh the table
                setTimeout(() => {
                  refreshServicesTable();
                }, 1000);
              }
            })
            .catch((error) => {
              console.error("Failed to save service:", error);
              alert("Failed to save service");
            });
        });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("serviceModal");
        if (event.target === modal) {
          closeModal();
        }
      };

      // Prevent modal from closing when mouse leaves during drag operations
      let isMouseDown = false;
      let isDragging = false;

      document.addEventListener("mousedown", function (event) {
        isMouseDown = true;
        isDragging = false;
      });

      document.addEventListener("mousemove", function (event) {
        if (isMouseDown) {
          isDragging = true;
        }
      });

      document.addEventListener("mouseup", function (event) {
        isMouseDown = false;
        // Reset dragging state after a short delay
        setTimeout(() => {
          isDragging = false;
        }, 100);
      });

      // Override the window.onclick for modal to prevent closing during drag
      const originalWindowOnclick = window.onclick;
      window.onclick = function (event) {
        const modal = document.getElementById("serviceModal");
        if (event.target === modal && !isDragging) {
          closeModal();
        }
      };

      // Add event listener for protocol change
      document
        .getElementById("protocol")
        .addEventListener("change", function () {
          const protocol = this.value;
          if (protocol !== "http") {
            // Reset multi-endpoint section for non-HTTP protocols
            document.getElementById("multi_endpoint_enabled").checked = false;
            document.getElementById("multi_endpoint_config").style.display =
              "none";
            document.getElementById("endpoints_container").innerHTML = "";
          }
        });

      // Auto-refresh table every 30 seconds
      function refreshServicesTable() {
        fetch("/api/v1/services")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((services) => {
            const tbody = document.querySelector(".table tbody");
            if (!tbody) {
              return;
            }
            tbody.innerHTML = "";

            // Handle both array and object formats
            let servicesArray = [];
            if (Array.isArray(services)) {
              servicesArray = services;
            } else if (typeof services === "object" && services !== null) {
              servicesArray = Object.values(services);
            } else {
              return;
            }

            servicesArray.forEach((service, index) => {
              const row = document.createElement("tr");

              // Get status and last check from state
              const status = service.state ? service.state.status : "unknown";
              const lastCheck =
                service.state && service.state.last_check
                  ? service.state.last_check
                  : null;

              // Generate tags HTML
              let tagsHtml = "";
              if (service.tags && service.tags.length > 0) {
                tagsHtml = service.tags
                  .map((tag) => `<span class="tag-badge">${tag}</span>`)
                  .join("");
              } else {
                tagsHtml = '<span class="no-tags">—</span>';
              }

              row.innerHTML = `
                <td style="text-align: center;">
                  <div class="activity-indicator ${
                    service.is_enabled !== false ? "active" : "inactive"
                  }" title="${
                service.is_enabled !== false ? "Enabled" : "Disabled"
              }"></div>
                </td>
                <td>
                  <a href="/service/${service.id}" class="service-name">${
                service.name
              }</a>
                </td>
                <td>
                  <span class="badge badge-${status.toLowerCase()}">
                    ${status.toUpperCase()}
                  </span>
                </td>
                <td>${tagsHtml}</td>
                <td>${service.endpoint}</td>
                <td>${formatDateTime(lastCheck)}</td>
                <td>
                  <div class="incidents-info">
                    <span class="incident-count active ${
                      (service.active_incidents || 0) === 0
                        ? "no-incidents"
                        : ""
                    }" data-service-id="${service.id}">${
                service.active_incidents || 0
              }</span>
                    <span class="incident-separator">/</span>
                    <span class="incident-count total" data-service-id="${
                      service.id
                    }">${service.total_incidents || 0}</span>
                  </div>
                </td>
                <td>
                  <div class="dropdown">
                    <button class="dropdown-toggle" onclick="toggleDropdown('${
                      service.id
                    }', event)">
                      Actions
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon lucide-chevron-down">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>
                    </button>
                    <div class="dropdown-menu" id="dropdown-${service.id}">
                      <button class="dropdown-item" onclick="triggerCheck('${
                        service.id
                      }')">
                        <span class="dropdown-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M8 16H3v5"/>
                          </svg>
                        </span> Check
                      </button>
                      <button class="dropdown-item" onclick="editService('${
                        service.id
                      }')">
                        <span class="dropdown-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil-icon lucide-pencil">
                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
                            <path d="m15 5 4 4"/>
                          </svg>
                        </span> Edit
                      </button>
                      <button class="dropdown-item" onclick="deleteService('${
                        service.id
                      }', '${service.name}')">
                        <span class="dropdown-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                          </svg>
                        </span> Delete
                      </button>
                    </div>
                  </div>
                </td>
              `;
              tbody.appendChild(row);
            });

            // Also refresh dashboard stats (no need to call loadIncidentsData anymore)
            loadDashboardStats();
          })
          .catch((error) => {
            console.error("Failed to refresh services:", error);
          });
      }

      // Load initial data
      loadDashboardStats();
      refreshServicesTable();

      // Initialize accordion as collapsed
      document.addEventListener("DOMContentLoaded", function () {
        const accordionBody = document.getElementById("protocolAccordion");
        const accordionIcon = document.getElementById("protocolAccordionIcon");
        if (accordionBody && accordionIcon) {
          accordionBody.style.display = "none";
          accordionIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon lucide-chevron-down">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>`;
        }
      });

      // Helper function to format datetime
      function formatDateTime(dateString) {
        if (!dateString) return "Never";
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      // Accordion toggle function
      function toggleAccordion(accordionId) {
        const accordionBody = document.getElementById(accordionId);
        const accordionIcon = document.getElementById(accordionId + "Icon");

        if (accordionBody.style.display === "none") {
          accordionBody.style.display = "block";
          accordionIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up-icon lucide-chevron-up"><path d="m18 15-6-6-6 6"/></svg>`;
        } else {
          accordionBody.style.display = "none";
          accordionIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>`;
        }
      }

      // Dropdown toggle function
      function toggleDropdown(serviceId, event) {
        // Prevent event bubbling
        if (event) {
          event.stopPropagation();
        }

        const dropdownMenu = document.getElementById("dropdown-" + serviceId);
        const dropdownToggle = dropdownMenu.previousElementSibling;

        // Close all other dropdowns
        const allDropdowns = document.querySelectorAll(".dropdown-menu");
        allDropdowns.forEach((dropdown) => {
          if (dropdown !== dropdownMenu) {
            dropdown.classList.remove("show");
            dropdown.style.top = "";
            dropdown.style.left = "";
          }
        });

        // Toggle current dropdown
        const isShowing = dropdownMenu.classList.toggle("show");

        if (isShowing) {
          // Calculate position relative to viewport
          const toggleRect = dropdownToggle.getBoundingClientRect();
          const menuWidth = 140; // min-width from CSS
          const menuHeight = 120; // approximate height of dropdown menu

          // Calculate vertical position
          let topPosition = toggleRect.bottom + 5;
          const viewportHeight = window.innerHeight;

          // If dropdown would overflow bottom, position it above the button
          if (topPosition + menuHeight > viewportHeight) {
            topPosition = toggleRect.top - menuHeight - 5;
          }

          dropdownMenu.style.top = topPosition + "px";

          // Calculate horizontal position
          const rightEdge = toggleRect.right;
          const viewportWidth = window.innerWidth;

          if (rightEdge + menuWidth > viewportWidth) {
            // If dropdown would overflow right edge, align to left
            dropdownMenu.style.left = rightEdge - menuWidth + "px";
          } else {
            // Otherwise align to right edge
            dropdownMenu.style.left = rightEdge - menuWidth + "px";
          }
        } else {
          // Clear positioning when hiding
          dropdownMenu.style.top = "";
          dropdownMenu.style.left = "";
        }

        // Update toggle button text
        if (isShowing) {
          dropdownToggle.innerHTML = `Actions
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up-icon lucide-chevron-up">
              <path d="m18 15-6-6-6 6"/>
            </svg>`;
        } else {
          dropdownToggle.innerHTML = `Actions
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon lucide-chevron-down">
              <path d="m6 9 6 6 6-6"/>
            </svg>`;
        }
      }

      // Function to close all dropdowns
      function closeAllDropdowns() {
        const allDropdowns = document.querySelectorAll(".dropdown-menu");
        allDropdowns.forEach((dropdown) => {
          dropdown.classList.remove("show");
          dropdown.style.top = "";
          dropdown.style.left = "";
        });

        // Reset all toggle buttons
        const allToggles = document.querySelectorAll(".dropdown-toggle");
        allToggles.forEach((toggle) => {
          toggle.innerHTML = `Actions
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon lucide-chevron-down">
              <path d="m6 9 6 6 6-6"/>
            </svg>`;
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".dropdown")) {
          closeAllDropdowns();
        }
      });

      // WebSocket connection for real-time updates
      let ws = null;
      let wsReconnectAttempts = 0;

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        try {
          ws = new WebSocket(wsUrl);

          ws.onopen = function () {
            console.log("WebSocket connected");
            wsReconnectAttempts = 0;
          };

          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);
              if (data.type === "service_update") {
                updateServicesTableFromWebSocket(data.services);
              }
            } catch (error) {
              console.error("Failed to parse WebSocket message:", error);
            }
          };

          ws.onclose = function () {
            console.log("WebSocket disconnected");

            setTimeout(connectWebSocket, 1000);
          };

          ws.onerror = function (error) {
            console.error("WebSocket error:", error);
          };
        } catch (error) {
          console.error("Failed to create WebSocket connection:", error);
        }
      }

      function updateServicesTableFromWebSocket(services) {
        const tbody = document.querySelector(".table tbody");
        if (!tbody) {
          return;
        }

        // Получаем существующие строки таблицы
        const existingRows = tbody.querySelectorAll("tr");
        const existingServices = new Map();

        existingRows.forEach((row) => {
          const serviceLink = row.querySelector(".service-name");
          if (serviceLink) {
            const serviceId = serviceLink.getAttribute("href").split("/").pop();
            existingServices.set(serviceId, row);
          }
        });

        // Обрабатываем каждый сервис из WebSocket
        services.forEach((service) => {
          const existingRow = existingServices.get(service.id);

          if (existingRow) {
            // Обновляем существующую строку без анимации
            updateExistingRow(existingRow, service);
            existingServices.delete(service.id); // Убираем из списка обработанных
          } else {
            // Добавляем новую строку
            const newRow = createServiceRow(service);
            tbody.appendChild(newRow);
          }
        });

        // Удаляем строки сервисов, которых больше нет
        existingServices.forEach((row) => {
          row.remove();
        });
      }

      function updateExistingRow(row, service) {
        // Обновляем статус
        const statusCell = row.querySelector("td:nth-child(3) .badge");
        if (statusCell) {
          const status = service.state ? service.state.status : "unknown";
          statusCell.className = `badge badge-${status.toLowerCase()}`;
          statusCell.textContent = status.toUpperCase();
        }

        // Обновляем время последней проверки
        const lastCheckCell = row.querySelector("td:nth-child(6)");
        if (lastCheckCell) {
          const lastCheck =
            service.state && service.state.last_check
              ? service.state.last_check
              : null;
          lastCheckCell.textContent = formatDateTime(lastCheck);
        }

        // Обновляем количество инцидентов
        const activeIncidentsSpan = row.querySelector(".incident-count.active");
        const totalIncidentsSpan = row.querySelector(".incident-count.total");

        if (activeIncidentsSpan) {
          const activeCount = service.active_incidents || 0;
          activeIncidentsSpan.textContent = activeCount;
          activeIncidentsSpan.className = `incident-count active ${
            activeCount === 0 ? "no-incidents" : ""
          }`;
        }

        if (totalIncidentsSpan) {
          totalIncidentsSpan.textContent = service.total_incidents || 0;
        }

        // Обновляем индикатор активности
        const activityIndicator = row.querySelector(".activity-indicator");
        if (activityIndicator) {
          activityIndicator.className = `activity-indicator ${
            service.is_enabled !== false ? "active" : "inactive"
          }`;
          activityIndicator.title =
            service.is_enabled !== false ? "Enabled" : "Disabled";
        }
      }

      function createServiceRow(service) {
        const row = document.createElement("tr");

        // Get status and last check from state
        const status = service.state ? service.state.status : "unknown";
        const lastCheck =
          service.state && service.state.last_check
            ? service.state.last_check
            : null;

        // Generate tags HTML
        let tagsHtml = "";
        if (service.tags && service.tags.length > 0) {
          tagsHtml = service.tags
            .map((tag) => `<span class="tag-badge">${tag}</span>`)
            .join("");
        } else {
          tagsHtml = '<span class="no-tags">—</span>';
        }

        row.innerHTML = `
          <td style="text-align: center;">
            <div class="activity-indicator ${
              service.is_enabled !== false ? "active" : "inactive"
            }" title="${
          service.is_enabled !== false ? "Enabled" : "Disabled"
        }"></div>
          </td>
          <td>
            <a href="/service/${service.id}" class="service-name">${
          service.name
        }</a>
          </td>
          <td>
            <span class="badge badge-${status.toLowerCase()}">
              ${status.toUpperCase()}
            </span>
          </td>
          <td>${tagsHtml}</td>
          <td>${service.endpoint}</td>
          <td>${formatDateTime(lastCheck)}</td>
          <td>
            <div class="incidents-info">
              <span class="incident-count active ${
                (service.active_incidents || 0) === 0 ? "no-incidents" : ""
              }" data-service-id="${service.id}">${
          service.active_incidents || 0
        }</span>
              <span class="incident-separator">/</span>
              <span class="incident-count total" data-service-id="${
                service.id
              }">${service.total_incidents || 0}</span>
            </div>
          </td>
          <td>
            <div class="dropdown">
              <button class="dropdown-toggle" onclick="toggleDropdown('${
                service.id
              }', event)">
                Actions
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon lucide-chevron-down">
                  <path d="m6 9 6 6 6-6"/>
                </svg>
              </button>
              <div class="dropdown-menu" id="dropdown-${service.id}">
                <button class="dropdown-item" onclick="triggerCheck('${
                  service.id
                }')">
                  <span class="dropdown-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw">
                      <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                      <path d="M21 3v5h-5"/>
                      <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                      <path d="M8 16H3v5"/>
                    </svg>
                  </span> Check
                </button>
                <button class="dropdown-item" onclick="editService('${
                  service.id
                }')">
                  <span class="dropdown-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil-icon lucide-pencil">
                      <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
                      <path d="m15 5 4 4"/>
                    </svg>
                  </span> Edit
                </button>
                <button class="dropdown-item" onclick="deleteService('${
                  service.id
                }', '${service.name}')">
                  <span class="dropdown-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash">
                      <path d="M3 6h18"/>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    </svg>
                  </span> Delete
                </button>
              </div>
            </div>
          </td>
        `;

        return row;
      }

      // Toggle switch function
      function toggleSwitch() {
        const checkbox = document.getElementById("is_enabled");
        checkbox.checked = !checkbox.checked;
      }

      // Toggle multi-endpoint function
      function toggleMultiEndpoint() {
        const checkbox = document.getElementById("multi_endpoint_enabled");
        checkbox.checked = !checkbox.checked;

        const configDiv = document.getElementById("multi_endpoint_config");
        if (checkbox.checked) {
          configDiv.style.display = "block";
          console.log("Multi-endpoint section enabled");
        } else {
          configDiv.style.display = "none";
          console.log("Multi-endpoint section disabled");
        }
      }

      // Add endpoint function
      function addEndpoint() {
        const container = document.getElementById("endpoints_container");
        const endpointCount = container.children.length + 1;

        const endpointDiv = document.createElement("div");
        endpointDiv.className = "endpoint-item";
        endpointDiv.innerHTML = `
          <div class="endpoint-header">
            <h5>Endpoint ${endpointCount}</h5>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeEndpoint(this)">
              Remove
            </button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Name</label>
              <input type="text" name="endpoint_name[]" placeholder="endpoint${endpointCount}" required />
            </div>
            <div class="form-group">
              <label>URL</label>
              <input type="url" name="endpoint_url[]" placeholder="https://api.example.com/status" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Method</label>
              <select name="endpoint_method[]">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
                <option value="HEAD">HEAD</option>
              </select>
            </div>
            <div class="form-group">
              <label>JSON Path</label>
              <input type="text" name="endpoint_json_path[]" placeholder="result.block_number" />
              <small class="form-text">Path to extract value from JSON response (e.g., "result.block_number")</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Username (Basic Auth)</label>
              <input type="text" name="endpoint_username[]" placeholder="username" />
            </div>
            <div class="form-group">
              <label>Password (Basic Auth)</label>
              <input type="password" name="endpoint_password[]" placeholder="password" />
            </div>
          </div>
          <div class="form-group">
            <label>Headers (JSON)</label>
            <textarea name="endpoint_headers[]" placeholder='{"Authorization": "Bearer token"}' rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>Body</label>
            <textarea name="endpoint_body[]" placeholder="Request body (for POST/PUT)" rows="2"></textarea>
          </div>
        `;

        container.appendChild(endpointDiv);
      }

      // Remove endpoint function
      function removeEndpoint(button) {
        const endpointItem = button.closest(".endpoint-item");
        endpointItem.remove();

        // Renumber endpoints
        const container = document.getElementById("endpoints_container");
        const endpoints = container.querySelectorAll(".endpoint-item");
        endpoints.forEach((endpoint, index) => {
          const header = endpoint.querySelector("h5");
          header.textContent = `Endpoint ${index + 1}`;
        });
      }

      // Connect to WebSocket when page loads
      connectWebSocket();
    </script>
  </body>
</html>
